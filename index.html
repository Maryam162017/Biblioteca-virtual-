<script>
// -----------------------------
// Variables globales
// -----------------------------
const ADMIN_PASS = "Informatica 2025";
let libros = []; // Lista global para todos los usuarios

// -----------------------------
// Cargar libros desde GitHub
// -----------------------------
fetch('https://raw.githubusercontent.com/Maryam162017/Biblioteca-virtual/main/libros.json')
  .then(res => res.json())
  .then(data => {
      libros = data;
      guardarLibros(libros); // Mantener compatibilidad con localStorage y botones
  });

// -----------------------------
// Funciones de almacenamiento
// -----------------------------
function cargarLibros() {
    let stored = localStorage.getItem("biblioteca");
    return stored ? JSON.parse(stored) : libros;
}

function guardarLibros(libros) {
    localStorage.setItem("biblioteca", JSON.stringify(libros));
}

function normalizar(texto) {
    return texto.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g, "");
}

// -----------------------------
// Funciones de interfaz
// -----------------------------

// Mostrar todos los libros
function mostrarLibros() {
    const librosActuales = cargarLibros();
    let html = "<h2>üìö Todos los libros</h2>";
    if (librosActuales.length > 0) {
        html += "<table><tr><th>T√≠tulo</th><th>Autor</th><th>A√±o</th><th>G√©nero</th><th>Estado</th></tr>";
        for (let libro of librosActuales) {
            html += `<tr>
                        <td>${libro.T√≠tulo}</td>
                        <td>${libro.Autor}</td>
                        <td>${libro.A√±o}</td>
                        <td>${libro.G√©nero}</td>
                        <td>${libro.Estado}</td>
                    </tr>`;
        }
        html += "</table>";
    } else {
        html += "<p>‚ö†Ô∏è No hay libros a√∫n.</p>";
    }
    html += `<br><button onclick="volverMenu()">Volver</button>`;
    document.getElementById("contenido").innerHTML = html;
}

// Buscar libro
function mostrarBuscar() {
    let html = `<h2>üîç Buscar libro</h2>
                T√≠tulo: <input id="busqueda" type="text">
                <button onclick="buscarLibro()">Buscar</button>
                <div id="resultado"></div>
                <br><button onclick="volverMenu()">Volver</button>`;
    document.getElementById("contenido").innerHTML = html;
}

function buscarLibro() {
    const busqueda = normalizar(document.getElementById("busqueda").value);
    const librosActuales = cargarLibros();
    const resultado = librosActuales.filter(libro => normalizar(libro.T√≠tulo).includes(busqueda));
    
    let html = "";
    if (resultado.length > 0) {
        html += "<table><tr><th>T√≠tulo</th><th>Autor</th><th>A√±o</th><th>G√©nero</th><th>Estado</th></tr>";
        for (let libro of resultado) {
            html += `<tr>
                        <td>${libro.T√≠tulo}</td>
                        <td>${libro.Autor}</td>
                        <td>${libro.A√±o}</td>
                        <td>${libro.G√©nero}</td>
                        <td>${libro.Estado}</td>
                    </tr>`;
        }
        html += "</table>";
    } else {
        html = "<p>‚ùå No se encontr√≥ ning√∫n libro.</p>";
    }
    document.getElementById("resultado").innerHTML = html;
}

// -----------------------------
// Admin
// -----------------------------
function mostrarAdminLogin() {
    const html = `<h2>üîê Acceso administrador</h2>
                  Contrase√±a: <input type="password" id="clave">
                  <button onclick="verificarAdmin()">Entrar</button>
                  <br><button onclick="volverMenu()">Volver</button>`;
    document.getElementById("contenido").innerHTML = html;
}

function verificarAdmin() {
    const clave = document.getElementById("clave").value;

    if (clave === ADMIN_PASS) {
        mostrarPanelAdmin();
    } else {
        const cont = document.getElementById("contenido");
        cont.innerHTML += `
            <div style="
                margin-top: 10px;
                padding: 12px;
                background: #ffd4d4;
                border: 1px solid #c78989;
                border-radius: 6px;
                color: #700;
            ">
                ‚ùå Contrase√±a incorrecta
            </div>
        `;
    }
}

// Panel admin
function mostrarPanelAdmin() {
    const html = `<h1>‚öôÔ∏è Panel de administrador</h1>
                  <button onclick="mostrarAgregar()">Agregar libro</button><br><br>
                  <button onclick="mostrarCambiarEstado()">Cambiar estado</button><br><br>
                  <button onclick="mostrarBorrar()">Borrar libro</button><br><br>
                  <button onclick="volverMenu()">Volver</button>`;
    document.getElementById("contenido").innerHTML = html;
}

// Agregar libro
function mostrarAgregar() {
    let html = `<h2>üìò Agregar libro</h2>
                T√≠tulo: <input id="titulo"><br>
                Autor: <input id="autor"><br>
                A√±o: <input id="a√±o"><br>
                G√©nero: <input id="genero"><br>
                Estado:
                <select id="estado">
                    <option value="Disponible">Disponible</option>
                    <option value="Prestado">Prestado</option>
                </select><br>
                <button onclick="agregarLibro()">Guardar</button>
                <br><button onclick="mostrarPanelAdmin()">Volver</button>`;
    document.getElementById("contenido").innerHTML = html;
}

function agregarLibro() {
    const libro = {
        T√≠tulo: document.getElementById("titulo").value,
        Autor: document.getElementById("autor").value,
        A√±o: document.getElementById("a√±o").value,
        G√©nero: document.getElementById("genero").value,
        Estado: document.getElementById("estado").value
    };
    let librosActuales = cargarLibros();
    librosActuales.push(libro);
    guardarLibros(librosActuales);

    document.getElementById("contenido").innerHTML = `
        <div style="
            padding: 12px;
            background: #d4ffd4;
            border: 1px solid #89c789;
            border-radius: 6px;
            margin-bottom: 12px;
        ">
            üìò Libro agregado correctamente
        </div>
    `;

    mostrarPanelAdmin();
}

// Cambiar estado
function mostrarCambiarEstado() {
    let html = `<h2>üì¶ Cambiar estado</h2>
                T√≠tulo del libro: <input id="tituloEstado"><br>
                Nuevo estado:
                <select id="nuevoEstado">
                    <option value="Disponible">Disponible</option>
                    <option value="Prestado">Prestado</option>
                </select><br>
                <button onclick="cambiarEstado()">Cambiar</button>
                <br><button onclick="mostrarPanelAdmin()">Volver</button>
                <div id="mensajeEstado"></div>`;
    document.getElementById("contenido").innerHTML = html;
}

function cambiarEstado() {
    const titulo = normalizar(document.getElementById("tituloEstado").value);
    const nuevo = document.getElementById("nuevoEstado").value;
    let librosActuales = cargarLibros();
    let encontrado = false;
    for (let libro of librosActuales) {
        if (normalizar(libro.T√≠tulo) === titulo) {
            libro.Estado = nuevo;
            encontrado = true;
            break;
        }
    }
    guardarLibros(librosActuales);
    document.getElementById("mensajeEstado").innerText = encontrado ? `‚úî Estado cambiado a '${nuevo}' correctamente` : "‚ùå Libro no encontrado";
}

// Borrar libro
function mostrarBorrar() {
    let html = `<h2>üóëÔ∏è Borrar libro</h2>
                T√≠tulo del libro: <input id="tituloBorrar"><br>
                <button onclick="borrarLibro()">Borrar</button>
                <br><button onclick="mostrarPanelAdmin()">Volver</button>
                <div id="mensajeBorrar"></div>`;
    document.getElementById("contenido").innerHTML = html;
}

function borrarLibro() {
    const titulo = normalizar(document.getElementById("tituloBorrar").value);
    let librosActuales = cargarLibros();
    const index = librosActuales.findIndex(libro => normalizar(libro.T√≠tulo) === titulo);
    if (index >= 0) {
        const eliminado = librosActuales.splice(index, 1);
        guardarLibros(librosActuales);
        document.getElementById("mensajeBorrar").innerText = `‚úî Libro '${eliminado[0].T√≠tulo}' eliminado correctamente`;
    } else {
        document.getElementById("mensajeBorrar").innerText = "‚ùå Libro no encontrado";
    }
}

// Volver al men√∫ principal
function volverMenu() {
    document.getElementById("contenido").innerHTML = "";
}
</script>
